{% extends 'base.html' %}

{% block meta %}
<title>Register - Football Shop</title>
{% endblock meta %}

{% block content %}
<div class="form-style">
  <div class="min-h-screen bg-gray-50 flex items-center justify-center p-8">
    <div class="max-w-md w-full relative z-10">
      <div class="bg-white border border-gray-200 rounded-lg p-8 shadow-sm">
      <div class="text-center mb-8">
        <h2 class="text-2xl font-semibold text-gray-900 mb-2">Join Us</h2>
        <p class="text-gray-500">Create your Football Shop account</p>
      </div>

      {% if form.non_field_errors %}
        <div class="mb-6">
          {% for error in form.non_field_errors %}
            <div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700">
              {{ error }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if form.errors %}
        <div class="mb-6">
          {% for field, errors in form.errors.items %}
            {% if field != '__all__' %}
              {% for error in errors %}
                <div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700 mb-2">
                  <strong>{{ field|title }}:</strong> {{ error }}
                </div>
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <div id="ajaxErrors" class="mb-6"></div>

      <form id="registerForm" method="POST" action="" class="space-y-5">
        {% csrf_token %}
        
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
          <input 
            id="username" 
            name="username" 
            type="text" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-blue-400 transition duration-200" 
            placeholder="Choose a username">
        </div>

        <div>
          <label for="password1" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
          <input 
            id="password1" 
            name="password1" 
            type="password" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-blue-400 transition duration-200" 
            placeholder="Create a password">
        </div>

        <div>
          <label for="password2" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
          <input 
            id="password2" 
            name="password2" 
            type="password" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-blue-400 transition duration-200" 
            placeholder="Confirm your password">
        </div>

        <button 
          type="submit" 
          id="registerSubmitBtn"
          class="w-full bg-blue-500 text-white font-medium py-3 px-4 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition duration-200">
          Create Account
        </button>
      </form>

      {% if messages %}
        <div class="mt-6">
          {% for message in messages %}
            <div 
              class="
                px-4 py-3 rounded text-sm border
                {% if message.tags == 'success' %}
                  bg-blue-50 border-blue-200 text-blue-700
                {% elif message.tags == 'error' %}
                  bg-red-50 border-red-200 text-red-700
                {% else %}
                  bg-gray-50 border-gray-200 text-gray-700
                {% endif %}
              ">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div id="ajaxMessages" class="mt-6"></div>

      <div class="mt-6 text-center">
        <p class="text-gray-500 text-sm">
          Already have an account? 
          <a href="{% url 'main:login' %}" class="text-blue-500 hover:text-blue-700 font-medium">
            Sign In
          </a>
        </p>
      </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  function getCookie(name) {
    const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return v ? decodeURIComponent(v.split('=')[1]) : null;
  }

  function titleCaseField(name) {
    return name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  function buildMessageElement(text, type='info') {
    const el = document.createElement('div');
    el.className = 'px-4 py-3 rounded text-sm border mb-2';
    if (type === 'success') {
      el.className += ' bg-blue-50 border-blue-200 text-blue-700';
    } else if (type === 'error') {
      el.className += ' bg-red-50 border-red-200 text-red-700';
    } else {
      el.className += ' bg-gray-50 border-gray-200 text-gray-700';
    }
    el.textContent = text;
    return el;
  }

  function clearAjaxAreas() {
    const errs = document.getElementById('ajaxErrors');
    const msgs = document.getElementById('ajaxMessages');
    if (errs) errs.innerHTML = '';
    if (msgs) msgs.innerHTML = '';
  }

  function showFieldErrors(fieldErrors) {
    const container = document.getElementById('ajaxErrors');
    if (!container) return;
    for (const [field, errors] of Object.entries(fieldErrors)) {
      errors.forEach(err => {
        const box = document.createElement('div');
        box.className = 'px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700 mb-2';
        const strong = document.createElement('strong');
        strong.textContent = titleCaseField(field) + ': ';
        box.appendChild(strong);
        box.appendChild(document.createTextNode(err));
        container.appendChild(box);
      });
    }
  }

  function showNonFieldErrors(errList) {
    const container = document.getElementById('ajaxErrors');
    if (!container) return;
    errList.forEach(err => {
      const box = document.createElement('div');
      box.className = 'px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700';
      box.textContent = err;
      container.appendChild(box);
    });
  }

  function showAjaxMessage(text, type='info') {
    const container = document.getElementById('ajaxMessages');
    if (!container) return;
    const el = buildMessageElement(text, type);
    container.appendChild(el);
  }

  const form = document.getElementById('registerForm');
  const submitBtn = document.getElementById('registerSubmitBtn');

  if (!form) return;

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    clearAjaxAreas();

    const originalBtnText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';

    let csrftoken = getCookie('csrftoken');
    if (!csrftoken) {
      const tokenInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
      if (tokenInput) csrftoken = tokenInput.value;
    }

    const formData = new FormData(form);

    try {
      const resp = await fetch("{% url 'main:register_ajax' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: formData,
        credentials: 'same-origin'
      });

      let data = null;
      try { data = await resp.json(); } catch (err) { data = null; }

      if (resp.ok && data && data.status === 'success') {
        showAjaxMessage(data.message || 'Registration successful', 'success');
        if (data.redirect_url) {
            window.location.href = data.redirect_url; 
        } else {
            location.reload();
        }
        return;
      }

      if (data) {
        if (data.errors) {
          showFieldErrors(data.errors);
        }
        if (data.field_errors) {
          showFieldErrors(data.field_errors);
        }
        if (data.non_field_errors) {
          showNonFieldErrors(data.non_field_errors);
        }
        if (data.message) {
          const container = document.getElementById('ajaxErrors');
          if (container) container.appendChild(buildMessageElement(data.message, 'error'));
          else showAjaxMessage(data.message, 'error');
        }
      } else {
        const text = await resp.text().catch(()=>null);
        const errText = text ? 'Pendaftaran gagal. Server merespons: ' + text.substring(0,200) : 'Pendaftaran gagal. Coba lagi.';
        const container = document.getElementById('ajaxErrors');
        if (container) container.appendChild(buildMessageElement(errText, 'error'));
        else showAjaxMessage(errText, 'error');
      }
    } catch (err) {
      console.error('AJAX register error:', err);
      showAjaxMessage('Terjadi kesalahan jaringan. Coba lagi.', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalBtnText;
    }
  });
})();
</script>
{% endblock content %}
